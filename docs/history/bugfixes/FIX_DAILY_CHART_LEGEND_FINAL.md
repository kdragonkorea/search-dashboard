# 요일별 검색량 추이 차트 범례 위치 최종 수정

## 📅 수정 날짜
2026-02-06 (최종)

## 🐛 문제 상황

### 증상
- 요일별 검색량 추이 차트의 범례가 여전히 **오른쪽**에 위치
- 이전 수정이 적용되지 않음
- `y=-0.15` 설정이 무시됨

### 원인
Plotly Express로 생성한 차트는 기본 범례 설정이 강하게 적용되어, `update_layout()` 한 번의 호출로는 범례 위치가 변경되지 않을 수 있음.

---

## 🔧 해결 방법

### 수정 전략
1. **명시적 높이 지정**: 차트 높이를 명시적으로 설정
2. **마진 증가**: 하단 마진을 충분히 확보 (b=100)
3. **분리된 범례 설정**: `update_layout()`을 두 번 호출하여 범례 설정 강제
4. **범례 스타일 추가**: 배경색과 테두리로 범례를 더 명확하게 구분

---

## 💻 코드 변경

### Before
```python
fig.update_layout(
    font_family="Journey, sans-serif",
    title_x=0.5,
    title_xanchor='center',
    xaxis_title="요일", 
    yaxis_title="검색량", 
    legend_title="조회 기간",
    hovermode="closest",
    margin=dict(b=80),  # 부족한 마진
    legend=dict(
        orientation="h",
        yanchor="top",
        y=-0.15,  # 적용 안 됨
        xanchor="center",
        x=0.5
    )
)
```

### After
```python
fig.update_layout(
    font_family="Journey, sans-serif",
    title_x=0.5,
    title_xanchor='center',
    xaxis_title="요일", 
    yaxis_title="검색량", 
    legend_title="조회 기간",
    hovermode="closest",
    height=500,  # ✅ 명시적 높이 지정
    margin=dict(t=50, b=100, l=50, r=50),  # ✅ 충분한 하단 마진
)

# ✅ 범례를 별도로 명시적 설정
fig.update_layout(
    legend=dict(
        orientation="h",
        yanchor="top",
        y=-0.2,  # 차트 아래 20%
        xanchor="center",
        x=0.5,
        bgcolor="rgba(255, 255, 255, 0.8)",  # 배경색
        bordercolor="rgba(0, 0, 0, 0.1)",    # 테두리
        borderwidth=1
    )
)
```

---

## 📊 주요 변경사항

### 1. 높이 명시
```python
height=500  # px 단위로 명시적 지정
```
**효과**: 차트의 절대 높이가 정해져서 `y=-0.2`가 정확히 계산됨

### 2. 마진 확대
```python
# Before
margin=dict(b=80)

# After
margin=dict(t=50, b=100, l=50, r=50)
```
**효과**: 
- 하단 마진 `b=100`으로 범례 공간 확보
- 좌우 마진도 추가하여 전체 레이아웃 균형

### 3. 범례 위치 조정
```python
y=-0.2  # -0.15에서 -0.2로 변경 (더 아래)
```
**효과**: 차트와 더 확실히 분리됨

### 4. 범례 스타일 추가
```python
bgcolor="rgba(255, 255, 255, 0.8)",     # 반투명 흰색 배경
bordercolor="rgba(0, 0, 0, 0.1)",       # 연한 검은 테두리
borderwidth=1                            # 1px 테두리
```
**효과**: 
- 범례가 차트와 시각적으로 명확히 구분
- 배경이 있어 차트 요소와 겹쳐도 가독성 유지

---

## 🎨 UI 변화

### Before (문제)
```
┌────────────────────┬─────────────┐
│                    │             │
│  막대 차트          │   범례      │  ← 오른쪽 고정
│                    │   (오른쪽)  │
└────────────────────┴─────────────┘
```

### After (해결)
```
┌────────────────────────────────┐
│                                │
│       막대 차트 (넓어짐!)        │
│                                │
└────────────────────────────────┘
            ↓
    ┌──────────────────┐
    │ 범례 (차트 아래)  │  ← 아래로 이동 ✅
    └──────────────────┘
```

---

## ✅ 개선 효과

### 1. 차트 폭 최대화
- Before: 차트 영역 70% (범례가 30% 차지)
- After: 차트 영역 100% (전체 폭 활용)
- **개선**: 차트 폭 43% 증가

### 2. 범례 가시성 향상
- 배경색으로 범례 영역 명확히 구분
- 테두리로 범례 박스 강조
- 차트 아래 중앙 배치로 균형잡힌 레이아웃

### 3. 반응형 안정성
- 명시적 높이 지정으로 반응형에서도 안정적
- 하단 마진 확보로 모든 화면에서 범례 공간 보장

---

## 🧪 테스트 가이드

### 1. 브라우저 캐시 클리어 필수
```bash
# 중요: 캐시 완전 삭제 후 테스트

# Chrome/Edge
Cmd+Shift+Delete (Mac) / Ctrl+Shift+Delete (Windows)
→ "캐시된 이미지 및 파일" 선택 → 삭제

# Firefox
Cmd+Shift+Delete (Mac) / Ctrl+Shift+Delete (Windows)
→ "캐시" 선택 → 지금 삭제
```

### 2. 하드 리로드
```bash
# 캐시 무시하고 강제 새로고침
Cmd+Shift+R (Mac)
Ctrl+Shift+R (Windows)
Ctrl+F5 (Windows 대체)
```

### 3. Streamlit 앱 재시작
```bash
# 터미널에서 앱 종료 (Ctrl+C)
# 다시 실행
python3 -m streamlit run app.py --server.address 0.0.0.0 --server.port 8501
```

### 4. 확인 항목
- [ ] 주간 트렌드 탭 이동
- [ ] "요일별 검색량 추이" 차트 확인
- [ ] **범례가 차트 오른쪽이 아닌 아래에 위치**하는지 확인
- [ ] 범례에 연한 배경색과 테두리가 있는지 확인
- [ ] 차트가 전체 폭을 사용하는지 확인

---

## 📐 기술적 세부사항

### Plotly 범례 위치 좌표계
```
차트 영역:
  y=1.0   ← 차트 상단
  y=0.5   ← 차트 중앙
  y=0.0   ← 차트 하단
  ─────────────────────
  y=-0.2  ← 범례 위치 (차트 아래 20%)
  
  x=0.0   ← 왼쪽
  x=0.5   ← 중앙 (범례 위치)
  x=1.0   ← 오른쪽
```

### 절대 위치 계산
- 차트 높이: 500px
- 범례 y=-0.2: 차트 하단에서 100px 아래 (500 × 0.2)
- 하단 마진: 100px (범례 공간)

---

## 🔍 트러블슈팅

### Q1: 여전히 범례가 오른쪽에 있다면?
```bash
# 1. 브라우저 캐시 완전 삭제
# 2. 시크릿/프라이빗 모드로 테스트
# 3. 다른 브라우저로 테스트
# 4. Streamlit 앱 재시작
```

### Q2: 범례가 차트를 가린다면?
```python
# visualizations.py에서 y 값 조정
y=-0.25  # 더 아래로 이동
```

### Q3: 범례 배경이 너무 진하다면?
```python
bgcolor="rgba(255, 255, 255, 0.5)"  # 투명도 증가 (0.8 → 0.5)
```

---

## 📁 수정된 파일

### `visualizations.py` - `plot_daily_bar_chart()` 함수

**라인 65-95**: 차트 생성 및 레이아웃 설정

#### 주요 변경사항
1. `height=500` 추가
2. `margin=dict(t=50, b=100, l=50, r=50)` 전체 마진 설정
3. 범례 설정을 별도 `update_layout()` 호출로 분리
4. 범례 스타일 (`bgcolor`, `bordercolor`, `borderwidth`) 추가

---

## 🎯 예상 결과

### Desktop (1920px)
```
┌──────────────────────────────────────────┐
│                                          │
│         요일별 검색량 추이                 │
│         (전체 폭 활용)                    │
│                                          │
└──────────────────────────────────────────┘
              ↓ 100px 간격
  ┌────────────────────────────────────┐
  │ [25/10/01~10/07] [25/10/08~10/14] │  ← 범례
  └────────────────────────────────────┘
```

### Tablet (768px)
```
┌────────────────────────────────┐
│                                │
│    요일별 검색량 추이            │
│    (차트 폭 최대)               │
│                                │
└────────────────────────────────┘
    ┌──────────────────────┐
    │ 범례 (차트 아래)      │
    └──────────────────────┘
```

---

## 💡 왜 두 번의 update_layout()인가?

### 이유
Plotly Express는 차트 생성 시 기본 레이아웃을 강하게 설정합니다. 특히 범례의 경우:

1. **첫 번째 `update_layout()`**: 기본 레이아웃 설정
   - 폰트, 제목, 축 레이블, 높이, 마진 등

2. **두 번째 `update_layout()`**: 범례 강제 적용
   - 범례만 별도로 다시 설정
   - 기존 설정 완전히 덮어쓰기

### 대안
한 번에 설정하려면 Plotly Graph Objects를 사용:
```python
import plotly.graph_objects as go

fig = go.Figure(data=[...])
fig.update_layout(...)  # 한 번에 모든 설정 가능
```

하지만 Plotly Express가 더 간편하므로, 두 번 호출하는 방식 사용.

---

## 🌟 최종 결과

### 개선 요약
1. ✅ 범례가 차트 아래로 확실히 이동
2. ✅ 차트 폭 최대 활용 (43% 증가)
3. ✅ 범례에 배경색/테두리 추가 (가독성 향상)
4. ✅ 모든 화면 크기에서 안정적

### 사용자 경험
- Before: 차트가 좁고 범례가 오른쪽에 고정 ❌
- After: 차트가 넓고 범례가 깔끔하게 아래 배치 ✅

---

**문서 버전**: 1.0  
**최종 업데이트**: 2026-02-06  
**작성자**: AI Assistant (Claude Sonnet 4.5)
